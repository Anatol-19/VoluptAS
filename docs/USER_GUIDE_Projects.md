# 🗂️ Руководство по Multi-Project Support

## 📋 Содержание
1. [Концепция](#концепция)
2. [Первый запуск и миграция](#первый-запуск-и-миграция)
3. [Создание проектов](#создание-проектов)
4. [Переключение между проектами](#переключение-между-проектами)
5. [Профили настроек](#профили-настроек)
6. [Управление проектами](#управление-проектами)
7. [Структура данных](#структура-данных)
8. [Частые вопросы](#частые-вопросы)

---

## 🎯 Концепция

**Multi-Project Support** позволяет работать с несколькими независимыми QA-проектами в одном экземпляре VoluptAS.

### Основные преимущества

✅ **Изоляция данных** - каждый проект имеет отдельную БД  
✅ **Независимые настройки** - свои credentials и профили  
✅ **Быстрое переключение** - смена контекста за 1 клик  
✅ **Организация** - теги, поиск, фильтры  
✅ **Гибкость** - Production / Sandbox / Custom profiles  

### Архитектура

```
projects/
├── project_config.json       # Реестр проектов
├── Default_Project_abc123/   # Первый проект
│   ├── project.db            # БД проекта
│   └── settings_profiles.json # Профили
└── MyApp_Testing_xyz789/     # Второй проект
    ├── project.db
    └── settings_profiles.json
```

---

## 🚀 Первый запуск и миграция

### Автоматическая миграция

При первом запуске **v0.4.0+**, если обнаружена старая структура (`data/voluptas.db`):

1. **Появится диалог миграции:**
   ```
   ┌─────────────────────────────────────┐
   │ Обнаружена старая структура БД      │
   │                                     │
   │ Выполнить миграцию в проекты?       │
   │                                     │
   │ [ Да, мигрировать ]  [ Нет ]        │
   └─────────────────────────────────────┘
   ```

2. **Что произойдёт:**
   - Создаётся папка `projects/Default_Project_<uuid>/`
   - Копируется `data/voluptas.db` → `projects/.../project.db`
   - Старая БД переименовывается: `voluptas.db.backup`
   - Создаётся запись проекта в `project_config.json`

3. **После миграции:**
   - Приложение работает с "Default Project"
   - Все данные сохранены
   - Старая БД остаётся как backup

### Новая установка

Если это свежая установка (нет старой БД):

- Создаётся "Default Project" автоматически
- Не требуется никаких действий

---

## ➕ Создание проектов

### Способ 1: Меню
```
Файл → Новый проект... (Ctrl+Shift+N)
```

### Способ 2: Стартовый диалог

Если нет активных проектов, появится диалог выбора с кнопкой **"Создать"**.

### Форма создания

```
┌─────────────────────────────────────────┐
│ Создание нового проекта                 │
├─────────────────────────────────────────┤
│ Название: [____________________]        │
│ Описание: [____________________]        │
│           [____________________]        │
│                                         │
│ Профиль:  ( ) 🏭 Production            │
│           (•) 🧪 Sandbox               │
│           ( ) 🎨 Custom                │
│                                         │
│ Теги:     [+] ________________          │
│           [client] [automation] [×]     │
│                                         │
│ [    Создать    ]  [ Отмена ]          │
└─────────────────────────────────────────┘
```

#### Поля:

| Поле | Обязательное | Описание |
|------|--------------|----------|
| **Название** | ✅ Да | Уникальное имя проекта (min 3 символа) |
| **Описание** | ❌ Нет | Комментарий для идентификации |
| **Профиль** | ✅ Да | Тип настроек (по умолчанию Sandbox) |
| **Теги** | ❌ Нет | Метки для поиска и группировки |

#### Результат:

- Создаётся папка `projects/<Название>_<uuid>/`
- Инициализируется БД `project.db` со схемой
- Создаётся `settings_profiles.json`
- Проект автоматически становится активным

---

## 🔄 Переключение между проектами

### 3 способа переключения

#### 1️⃣ Toolbar (быстрый доступ)

```
┌────────────────────────────────┐
│ [Default Project ▼] [⚙]       │ ← Выпадающий список
└────────────────────────────────┘
```

Отображается:
- Название проекта
- Emoji профиля (🏭 / 🧪 / 🎨)
- Теги (если есть)

#### 2️⃣ Меню

```
Файл → Переключить проект... (Ctrl+Shift+P)
```

Открывает **ProjectSelectorDialog** с полным списком.

#### 3️⃣ Диалог выбора

```
┌─────────────────────────────────────────┐
│ Выбор проекта                           │
├─────────────────────────────────────────┤
│ Поиск: [_____________________] [🔍]     │
│                                         │
│ Фильтр: [Все ▼] [🏭▼] [Все теги ▼]     │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ 🏭 Default Project                  │ │
│ │    Основной проект (production)     │ │
│ │    Создан: 2025-01-15               │ │
│ │    Используется: 35 раз             │ │
│ ├─────────────────────────────────────┤ │
│ │ 🧪 Staging Environment              │ │
│ │    Тестовое окружение               │ │
│ │    [staging] [automation]           │ │
│ │    Используется: 12 раз             │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ [  Открыть  ]  [Создать]  [ Отмена ]   │
└─────────────────────────────────────────┘
```

**Возможности:**
- 🔍 Поиск по названию/описанию
- 🏷️ Фильтр по профилю (Production/Sandbox/Custom)
- 🔖 Фильтр по тегам
- 📊 Статистика использования
- ⚙️ Кнопка настроек проекта

### Что происходит при переключении

1. **Закрывается текущая сессия БД**
2. **Загружается новая БД** из папки проекта
3. **Применяются настройки профиля** (credentials)
4. **Обновляется UI:**
   - Заголовок окна: `VoluptAS - <ProjectName> 🏭`
   - Toolbar: новое имя проекта
   - Все вкладки перезагружаются
5. **Сохраняется выбор** (при следующем запуске откроется тот же проект)

---

## ⚙️ Профили настроек

### Типы профилей

#### 🏭 Production
- Рабочие учётные данные
- Zoho Production API
- Google Sheets основной аккаунт
- Qase.io production workspace

#### 🧪 Sandbox
- Тестовые credentials
- Zoho Sandbox API
- Тестовые Google Sheets
- Qase sandbox workspace

#### 🎨 Custom
- Пользовательские настройки
- Произвольные комбинации
- Кастомные endpoints

### Структура профиля

```json
{
  "production": {
    "zoho": {
      "client_id": "...",
      "client_secret": "...",
      "refresh_token": "...",
      "portal_id": "..."
    },
    "google_sheets": {
      "service_account_path": "..."
    },
    "qase": {
      "api_token": "...",
      "workspace_id": "..."
    }
  },
  "sandbox": { /* аналогично */ },
  "custom": { /* аналогично */ }
}
```

### Редактирование профиля

```
Файл → Настройки проекта... → Вкладка "Интеграции"
```

**Для каждого профиля настраиваются:**
- Zoho Projects API credentials
- Google Sheets service account
- Qase.io API token и workspace
- TestRail credentials (если используется)

**Обратная совместимость:**
- Если профиля нет, используются настройки из `config_zoho.env`
- При сохранении через старый SettingsDialog создаётся профиль

---

## 🔧 Управление проектами

### Настройки проекта

```
Файл → Настройки проекта... (или ⚙️ в диалоге выбора)
```

#### Вкладка "Основное"

```
┌─────────────────────────────────────────┐
│ Название:  [Default Project______]      │
│ Описание:  [Основной проект______]      │
│            [____________________]        │
│                                         │
│ Профиль:   [🏭 Production ▼]            │
│                                         │
│ Теги:      [client] [prod] [×]          │
│            [+] Добавить                 │
│                                         │
│ Статистика:                             │
│   Создан:         2025-01-10            │
│   Изменён:        2025-01-15 14:30      │
│   Использований:  45                    │
│                                         │
│ [ Сохранить ]  [ Отмена ]               │
└─────────────────────────────────────────┘
```

#### Вкладка "Интеграции"

Настройка credentials для выбранного профиля (см. раздел "Профили настроек").

#### Вкладка "Экспорт/Импорт"

```
Экспорт проекта:  [ Экспортировать в .zip ]
Импорт проекта:   [ Импортировать .zip ]
Удаление данных:  [ Очистить БД ] [ Удалить проект ]
```

**Экспорт включает:**
- `project.db` (БД со всеми данными)
- `settings_profiles.json` (настройки профилей)
- `project_meta.json` (название, описание, теги)

---

## 📁 Структура данных

### Директория проектов

```
projects/
├── project_config.json                    # Реестр всех проектов
├── Default_Project_a1b2c3d4/             # ID проекта = <Name>_<UUID>
│   ├── project.db                        # SQLite база
│   ├── settings_profiles.json            # Credentials для профилей
│   └── exports/                          # Экспорты (опционально)
├── ClientX_Testing_e5f6g7h8/
│   ├── project.db
│   └── settings_profiles.json
└── MyApp_Sandbox_i9j0k1l2/
    ├── project.db
    └── settings_profiles.json
```

### project_config.json

```json
{
  "projects": {
    "Default_Project_a1b2c3d4": {
      "name": "Default Project",
      "description": "Основной проект после миграции",
      "folder": "projects/Default_Project_a1b2c3d4",
      "profile": "production",
      "tags": ["main", "prod"],
      "created_at": "2025-01-10T10:00:00",
      "modified_at": "2025-01-15T14:30:00",
      "used_count": 45
    }
  },
  "last_active_project_id": "Default_Project_a1b2c3d4"
}
```

### settings_profiles.json

Хранится в каждой папке проекта, содержит credentials для всех профилей (production/sandbox/custom).

---

## ❓ Частые вопросы

### Q: Можно ли работать с несколькими проектами одновременно?
**A:** Нет, активен только один проект. Для параллельной работы запустите несколько экземпляров VoluptAS (не рекомендуется из-за возможных блокировок БД).

### Q: Что делать, если миграция не запустилась?
**A:** Проверьте:
1. Наличие `data/voluptas.db`
2. Права доступа к папке `projects/`
3. Логи в консоли (если запущено через `start_voluptas.bat`)

Ручная миграция:
```python
from src.ui.multi_project.migration_manager import MigrationManager
MigrationManager.migrate_to_multiproject()
```

### Q: Можно ли переименовать проект?
**A:** Да, через **Файл → Настройки проекта → Основное → Название**. Папка и UUID остаются неизменными.

### Q: Как восстановить backup после миграции?
**A:**
1. Переименуйте `data/voluptas.db.backup` → `data/voluptas.db`
2. Удалите `projects/project_config.json`
3. Перезапустите VoluptAS (миграция предложится снова)

### Q: Куда импортируются данные через "Файл → Импорт"?
**A:** В активный проект (отображается в заголовке окна и toolbar).

### Q: Можно ли перенести данные между проектами?
**A:** Да:
1. Экспортируйте данные из проекта A в CSV/Excel
2. Переключитесь на проект B
3. Импортируйте CSV/Excel в проект B

Или используйте **Экспорт проекта (.zip)** → **Импорт проекта** для полного копирования.

### Q: Как удалить проект?
**A:**
```
Файл → Настройки проекта → Экспорт/Импорт → Удалить проект
```

⚠️ **Внимание:** Удаление необратимо! Сначала создайте backup через "Экспортировать в .zip".

### Q: Профили применяются только к новым данным?
**A:** Нет, профиль определяет credentials для всех интеграций. При переключении профиля все запросы к API (Zoho, Qase, Google) используют новые credentials.

### Q: Что значит "used_count" в статистике?
**A:** Количество активаций проекта (каждое переключение увеличивает счётчик). Помогает определить наиболее часто используемые проекты.

---

## 🛠️ Устранение неполадок

### Проект не переключается

**Симптом:** Выбран новый проект, но UI показывает старые данные.

**Решение:**
1. Проверьте заголовок окна (должен измениться)
2. Перезагрузите вкладки через **Вид → Обновить**
3. Перезапустите VoluptAS

**Логи:**
```
DatabaseManager: Switching to project <ID>
DatabaseManager: Successfully connected to <path>
```

### Ошибка "Could not open project database"

**Причина:** Повреждена БД или нет прав доступа.

**Решение:**
1. Проверьте файл `projects/<ProjectID>/project.db`
2. Попробуйте открыть через DB Browser for SQLite
3. Восстановите из backup (если есть экспорт .zip)

### Настройки интеграций не применяются

**Причина:** Не сохранены изменения в `settings_profiles.json`.

**Решение:**
1. Откройте **Файл → Настройки проекта → Интеграции**
2. Убедитесь, что выбран правильный профиль
3. Нажмите **Сохранить** (не закрывайте через X!)
4. Перезапустите VoluptAS для применения

---

## 📞 Поддержка

**Документация:**
- [README.md](../README.md) - Общая информация
- [QUICKSTART.md](../QUICKSTART.md) - Быстрый старт
- [MIGRATION_CONCEPT.md](./MIGRATION_CONCEPT.md) - Технические детали миграции

**GitHub Issues:**
- [Сообщить о баге](https://github.com/yourusername/VoluptAS/issues)
- [Запросить функцию](https://github.com/yourusername/VoluptAS/issues/new?template=feature_request.md)

---

**Версия документа:** 1.0 (2025-01-16)  
**Применимо к:** VoluptAS v0.4.0+
